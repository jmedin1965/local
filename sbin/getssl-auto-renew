#!/bin/sh

prog="/usr/local/sbin/getssl --all --upgrade"
logdir="/var/log/getssl"
log="${logdir}/renew.log"
sucessMsg="No renewals were attempted."
mailSubject="${prog##*/} from $(/bin/hostname)"
mailTo="root"

[ -d "$logdir" ] || /bin/mkdir -p "$logdir"
/usr//bin/tty -s && echo "start run: $prog"
msg="$(/bin/date "+%b %d %H:%M:%S getssl"; $prog 2>&1; echo ;echo EV = $?)"
[ -n "$log" ] && echo "$msg" >> "$log"
if [ "$(echo "$msg" | /bin/fgrep -c "$sucessMsg")" -eq 0 ]
then
	/usr/bin/tty -s && echo emailing
	echo "$msg" | /usr/bin/mail -s "$mailSubject" $mailTo
else
	/usr/bin/tty -s && echo not emailing
fi

/usr/bin/tty -s && echo "==================== message ===================="
/usr/bin/tty -s && echo "$msg"

exit 0

#
# Check if cer is different to what it was
#
[ -f /etc/letsencrypt/certs.md5 ] && mv /etc/letsencrypt/certs.md5 /etc/letsencrypt/certs.md5.old
/usr/bin/md5sum /etc/letsencrypt/live/*/* > /etc/letsencrypt/certs.md5

if [ -f /etc/letsencrypt/certs.md5.old -a "$(/bin/cat /etc/letsencrypt/certs.md5)" != "$(/bin/cat /etc/letsencrypt/certs.md5.old)" ]
then
	/usr//bin/tty -s && echo restarting apache
	/etc/init.d/apache2 restart >> "$log" 2>&1
fi

